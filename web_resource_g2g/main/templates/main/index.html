{% extends "users/base.html" %}
{% block content %}
{% if user.is_authenticated %}

<style>
    .center-container {
        text-align: center;
    }
    table {
        margin: 0 auto;
        width: 80%; /* Or set a fixed width if desired */
        border-collapse: collapse; /* Ensures borders between cells */
        background-color: rgba(255, 255, 255, 0);

    }
    th, td {
        border: 1px solid #ddd; /* Border style and color for cells */
        padding: 5px; /* Spacing between cell content and borders */
        background-color: transparent;

    }
    .price-column {
         width: 200px;
    }

</style>
  <div class="center-container">
    <table >
      <thead>
          <tr>
              <th></th>
              <th>Гра</th>
              <th>Сервер</th>
              <th>Ціна</th>
              <th>Запас</th>
              <th>Стратегія</th>
          </tr>
      </thead>
      <tbody>
        {% for row in bets_list %}
          <tr id="{{row.id}}">
            <td>{{ forloop.counter }}</td>
            <form method="post" id="bet-form-{{ row.id }}" action="{% url 'main:update_table_data' %}" >
              {% csrf_token %}
              <td><input type="text" value="{{ row.server_name }}" readonly></td>
              <td style="width: 200px;"><input type="text" value="{{ row.game_name }}" readonly></td>
              <td><input type="text" value="{{ row.price }}" id="price-field-{{row.id}}" readonly></td>
              <td style="width: 200px;"><input type="text" value="{{ row.stock}}" name="stock"></td>
              <td>
                <select class="strategy-select" name="price" id="strategySelect_{{ row.id }}">
                  <option value="mean20_lot" {% if row.strategy_price == "mean20_lot" %}selected{% endif %}>Дорого</option>
                  <option value="mean10_lot" {% if row.strategy_price == "mean10_lot" %}selected{% endif %}>Баланс</option>
                  <option value="minimal" {% if row.strategy_price == "minimal" %}selected{% endif %}>Швидко</option>
                </select>
              </td>
            </form>
          </tr>
        {% endfor %}

      </tbody>
      </table>
  </div>
  <div class="center-container" style="justify-content: space-between;">
    <span><button class="save-button">Додати сервер</button></span>
    <span><button class="save-button">Розмістити пропозиції</button></span>
  </div>

<div id="add-server-form" style="display: none;">
    <table>
      <thead>
        <tr id="add-server-head">
          <th>Гра</th>
          <th>Регіон</th>
          <th>Сервер</th>
        </tr>
      </thead>
      <tbody>
        <form method="post" action="{% url 'main:add_server' %}">
          {% csrf_token %}
          <tr id="add-server-body">
            <td>
              <select class="game-select" id="game-name-select">
                {% for game in games %}
                  <option value="{{ game }}">{{ game }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <select class="game-select" id="region-select">
                {% for region in regions %}
                  <option value="{{ region }}">{{ region }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <select class="game-select" id="server-select">
                </select>
            </td>
          </tr>
        </form>
       </tbody>
      </table>
         <div class="center-container" style="justify-content: space-between;">
           <span><button class="save-button" id="add-server-button">Готово</button></span>
           <span><button class="save-button">Скасувати</button></span>
         </div>
</div>

<script>
  // Глобальні змінні для форми додавання сервера
  const addServerButton = document.getElementById('add-server-button');
  const gameSelect = document.getElementById('game-name-select');
  const regionSelect = document.getElementById('region-select');
  const serverSelect = document.getElementById('server-select');
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Обробник кнопки "Готово"
  addServerButton.addEventListener('click', (event) => {
    event.preventDefault();

    const formData = {
      game: gameSelect.value,
      region: regionSelect.value,
      server: serverSelect.value,
    };

    fetch("{% url 'main:add_server' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify(formData),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log(data);
      })
      .catch((error) => {
        console.error('Error:', error);
      });
  });
</script>

<script>
  // Локальні змінні для роботи із серверами
  const serversData = {{ servers_json | safe }};

  function updateServers(game, region) {
    const selectedServers = serversData[game]?.[region] || [];
    serverSelect.innerHTML = '';

    selectedServers.forEach((server) => {
      const option = document.createElement('option');
      option.value = server;
      option.textContent = server;
      serverSelect.appendChild(option);
    });
  }

  gameSelect.addEventListener('change', () => {
    updateServers(gameSelect.value, regionSelect.value);
  });

  regionSelect.addEventListener('change', () => {
    updateServers(gameSelect.value, regionSelect.value);
  });

  // Ініціалізація
  updateServers(gameSelect.value, regionSelect.value);
</script>

<script>
  // Унікальна функція для управління відображенням форми
  const toggleAddServerForm = document.querySelector('.save-button:first-child');
  const addServerForm = document.getElementById('add-server-form');

  toggleAddServerForm.addEventListener('click', () => {
    addServerForm.style.display = addServerForm.style.display === 'none' ? 'block' : 'none';
  });
</script>

<script>
  const tableRows = document.querySelectorAll('tr:not(#add-server-body):not(#add-server-head)');
  const csrftoken = document.cookie.split(';')
    .map(c => c.trim())
    .find(c => c.startsWith('csrftoken='))
    ?.split('=')[1];

  if (!csrftoken) {
    console.error('CSRF token not found!');
  }

  tableRows.forEach(row => {
    const inputs = row.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.addEventListener('change', () => {
        const rowId = row.id;
        const fieldName = input.name;
        const newValue = input.value;

        console.log(`Detected change - Row ID: ${rowId}, Field: ${fieldName}, New Value: ${newValue}`);

        const data = {
          row_id: rowId,
          field_name: fieldName,
          new_value: newValue
        };

        fetch({% url "main:update_table_data" %}, {  // Replace this with actual URL if needed
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
  .then(data => {
    console.log('Server response:', data); // Логування відповіді сервера

    if (data.success) {
      // Знаходимо поле ціни в поточному рядку за допомогою класу чи іншого атрибута
      const rowId = row.id;
      const priceInputId = `price-field-${rowId}`;
      const priceInput = document.querySelector(`#${priceInputId}`);
      if (priceInput) {
        console.log(`Оновлюємо поле ціни в рядку ID ${rowId} з новим значенням: ${data.new_price}`);
        priceInput.value = data.new_price;
      } else {
        console.warn(`Поле ціни не знайдено у рядку ID: ${rowId}`);
      }
    } else {
      console.error('Не вдалося оновити дані:', data);
    }
})
.catch(error => {
  console.error('Помилка під час fetch запиту:', error); // Логування помилок запиту
});

      });
    });
  });
</script>


{% endif %}
{% endblock %}
